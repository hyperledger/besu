/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.privacy.privatetransaction;

import org.hyperledger.besu.crypto.SECP256K1.KeyPair;
import org.hyperledger.besu.ethereum.core.Address;
import org.hyperledger.besu.ethereum.core.Wei;
import org.hyperledger.besu.ethereum.privacy.PrivateTransaction;
import org.hyperledger.besu.ethereum.privacy.Restriction;
import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;
import org.hyperledger.besu.ethereum.rlp.RLP;
import org.hyperledger.besu.util.bytes.BytesValue;

import java.util.List;

public abstract class GroupCreationTransactionFactory {

  private static final BytesValue DEFAULT_PRIVACY_MANAGEMENT_BYTECODE =
      BytesValue.fromHexString("0x608060405234801561001057600080fd5b50604051610afe380380610afe8339818101604052604081101561003357600080fd5b81019080805190602001909291908051604051939291908464010000000082111561005d57600080fd5b8382019150602082018581111561007357600080fd5b825186602082028301116401000000008211171561009057600080fd5b8083526020830192505050908051906020019060200280838360005b838110156100c75780820151818401526020810190506100ac565b505050509050016040525050506100e3826100fc60201b60201c565b506100f4828261016e60201b60201c565b50505061047c565b600080600160008481526020019081526020016000205414156101645760008290806001815401808255809150509060018203906000526020600020016000909192909190915055600160008481526020019081526020016000208190555060019050610169565b600090505b919050565b6000806001905060008090505b83518110156104515783818151811061019057fe5b6020026020010151851415610224577fcc7365305ae5f16c463d1383713d699f43c5548bbda5537ee61373ceb9aaf21360008583815181106101ce57fe5b60200260200101516040518083151515158152602001828152602001806020018281038252602f815260200180610acf602f9139604001935050505060405180910390a181801561021d575060005b9150610444565b61024684828151811061023357fe5b602002602001015161045c60201b60201c565b156102ed577fcc7365305ae5f16c463d1383713d699f43c5548bbda5537ee61373ceb9aaf213600085838151811061027a57fe5b60200260200101516040518083151515158152602001828152602001806020018281038252601b8152602001807f4163636f756e7420697320616c72656164792061204d656d6265720000000000815250602001935050505060405180910390a18180156102e6575060005b9150610443565b60006103118583815181106102fe57fe5b60200260200101516100fc60201b60201c565b9050606081610355576040518060400160405280601b81526020017f4163636f756e7420697320616c72656164792061204d656d626572000000000081525061036f565b604051806060016040528060218152602001610aae602191395b90507fcc7365305ae5f16c463d1383713d699f43c5548bbda5537ee61373ceb9aaf2138287858151811061039f57fe5b602002602001015183604051808415151515815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b838110156103f85780820151818401526020810190506103dd565b50505050905090810190601f1680156104255780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a183801561043e5750815b935050505b5b808060010191505061017b565b508091505092915050565b600080600160008481526020019081526020016000205414159050919050565b6106238061048b6000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80630b0235be1461003b578063f744b089146100be575b600080fd5b6100676004803603602081101561005157600080fd5b8101908080359060200190929190505050610198565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156100aa57808201518184015260208101905061008f565b505050509050019250505060405180910390f35b61017e600480360360408110156100d457600080fd5b8101908080359060200190929190803590602001906401000000008111156100fb57600080fd5b82018360208201111561010d57600080fd5b8035906020019184602083028401116401000000008311171561012f57600080fd5b919080806020026020016040519081016040528093929190818152602001838360200280828437600081840152601f19601f820116905080830192505050505050509192919290505050610204565b604051808215151515815260200191505060405180910390f35b60606101a38261022a565b6101ac57600080fd5b60008054806020026020016040519081016040528092919081815260200182805480156101f857602002820191906000526020600020905b8154815260200190600101908083116101e4575b50505050509050919050565b600061020f8361022a565b61021857600080fd5b610222838361024a565b905092915050565b600080600160008481526020019081526020016000205414159050919050565b6000806001905060008090505b83518110156105215783818151811061026c57fe5b6020026020010151851415610300577fcc7365305ae5f16c463d1383713d699f43c5548bbda5537ee61373ceb9aaf21360008583815181106102aa57fe5b60200260200101516040518083151515158152602001828152602001806020018281038252602f8152602001806105c0602f9139604001935050505060405180910390a18180156102f9575060005b9150610514565b61031c84828151811061030f57fe5b602002602001015161022a565b156103c3577fcc7365305ae5f16c463d1383713d699f43c5548bbda5537ee61373ceb9aaf213600085838151811061035057fe5b60200260200101516040518083151515158152602001828152602001806020018281038252601b8152602001807f4163636f756e7420697320616c72656164792061204d656d6265720000000000815250602001935050505060405180910390a18180156103bc575060005b9150610513565b60006103e18583815181106103d457fe5b602002602001015161052c565b9050606081610425576040518060400160405280601b81526020017f4163636f756e7420697320616c72656164792061204d656d626572000000000081525061043f565b60405180606001604052806021815260200161059f602191395b90507fcc7365305ae5f16c463d1383713d699f43c5548bbda5537ee61373ceb9aaf2138287858151811061046f57fe5b602002602001015183604051808415151515815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b838110156104c85780820151818401526020810190506104ad565b50505050905090810190601f1680156104f55780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a183801561050e5750815b935050505b5b8080600101915050610257565b508091505092915050565b600080600160008481526020019081526020016000205414156105945760008290806001815401808255809150509060018203906000526020600020016000909192909190915055600160008481526020019081526020016000208190555060019050610599565b600090505b91905056fe4d656d626572206163636f756e74206164646564207375636365737366756c6c79416464696e67206f776e206163636f756e742061732061204d656d626572206973206e6f74207065726d6974746564a265627a7a72315820500a3e3b361949d10453bd90b12c77fc26a0fb1afd7939411738cbc3d264a80264736f6c634300050c0032");

  public abstract PrivateTransaction create(
      final BytesValue privacyGroupId,
      final BytesValue privateFrom,
      final List<BytesValue> participants);

  protected PrivateTransaction create(
      final BytesValue privateFrom,
      final BytesValue privacyGroupId,
      final List<BytesValue> participants,
      final long nonce,
      final KeyPair signingKey) {
    final BytesValueRLPOutput rlpEncodedParameters = new BytesValueRLPOutput();
    rlpEncodedParameters.startList();
    rlpEncodedParameters.writeBytesValue(privateFrom);
    rlpEncodedParameters.writeList(participants, (b, o) -> o.writeBytesValue(b));
    rlpEncodedParameters.endList();
    final BytesValue payload =
        DEFAULT_PRIVACY_MANAGEMENT_BYTECODE.concat(rlpEncodedParameters.encoded());
    return PrivateTransaction.builder()
        .nonce(nonce)
        .gasPrice(Wei.of(1000))
        .gasLimit(3000000)
        .value(Wei.ZERO)
        .payload(payload)
        .privateFrom(privateFrom)
        .privacyGroupId(privacyGroupId)
        .restriction(Restriction.RESTRICTED)
        .signAndBuild(signingKey);
  }
}
